{% extends 'base.html' %}
{% load wagtailimages_tags mmee_wagtail_tags %}

{% block main %}

{% verbatim %}
<main id="search-screen">

    <section id="search">

       <div class="search-field">
            <input v-model="meta.query.phrase" @keyup.enter="phrase_submit">
            
            <button class="search-icon" v-on:click="phrase_submit"></button>
            <button class="location-icon"></button>

        </div>
        <div class="search-filters">
            <div class="filter">
                <input type="checkbox" id="filter-nav" />
                <label aria-label="Filter list" class="filter-label" for="filter-nav">
                    Filter
                </label>
                <div class="filter-list">
                  <ul>
                    <li>
                      <h2>Filters</h2>
                      <form action="">
                        <h3>Categories</h3>
                        
                        <template v-for="facet in meta.facets">
                            <h4>{{ facet[0] }}</h4>
                            <div v-for="option in facet[1]">
                                <label>
                                    <input type="checkbox" 
                                        v-bind:name="option[0]+':'+option[1]" 
                                        value="1" v-bind:checked="option[4]" 
                                        v-on:click="on_change_option(option, $event)">
                                    {{ option[2] }} ({{ option[3] }})
                                </label>
                            </div>
                        
                        </template>
                        
                        <button aria-label="apply filter">Apply filter</button>
                      </form>
                    </li>
                  </ul>
                </div>
            </div>
            <div class="sort">
                <select aria-label="Sort by" v-model="meta.query.order">
                  <option value="newest">Newest</option>
                  <option value="oldest">Oldest</option>
                </select>
            </div>
        </div> <!-- end .filter-sort -->
    </section> <!-- end #search -->

    <section id="results">
        
        <p class="stats">
            <a href="#" v-on:click.prevent="on_click_previous_page" class="paging page-previous">Previous page</a>
            Found {{ meta.pagination.count }} Photo(s). Page {{ meta.pagination.page }} / {{ meta.pagination.pages }}
            <a href="#" v-on:click.prevent="on_click_next_page" class="paging page-next">Next page</a>
        </p>
    
        <input id="tab1" type="radio" name="tabs"  checked>
        <label for="tab1"><span>Grid</span></label>

        <input id="tab2" type="radio" name="tabs">
        <label for="tab2"><span>List</span></label>

        <input id="tab3" type="radio" name="tabs" >
        <label for="tab3"><span>Map</span></label>

        <article id="photo-grid" class="tab-content">
            <div v-for="photo in photos" class="photo">
              <div class="photo-image">
                <a v-bind:href="photo.attributes.url+'?'+meta.qs" v-html="photo.attributes.image">
                </a>
              </div>
            </div>
            <p><a href="#" v-on:click.prevent="on_click_load_more">Show {{ meta.pagination.per_page }} more</a></p>
        </article>
  <!--<div class="breadcrumb ">
      <h3>Sidebar</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Ab maxime fugiat perspiciatis.</p>
    </div>-->
        <article id="photo-list" class="tab-content">
            <div v-for="photo in photos" class="photo">
                <div class="photo-image">
                  <a v-bind:href="photo.attributes.url+'?'+meta.qs" v-html="photo.attributes.image">
                  </a>
                </div>
                <div class="photodata">
                    <h2>{{ photo.attributes.description }}</h2>
                    <p v-if="photo.attributes.date">Date taken: {{ photo.attributes.date }}</p>
                </div>
            </div>
            <p><a href="#" v-on:click.prevent="on_click_load_more">Show {{ meta.pagination.per_page }} more</a></p>
        </article>

        <article id="photo-map" class="tab-content">
          <div id="map">
          </div>
        </article>

    </section> <!-- end #results -->

</main>
{% endverbatim %}

{% endblock %}

{% block footer_scripts %}
<script>

$(function() {
    // Create map and set view
    var photomap = L.map('map').setView([51.52, -0.03], 12);
    // Create tilelayer and add to map
    var tileLayer = L.tileLayer("http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.png").addTo(photomap);
    var markers = [];

    function update_map(photos) {
      markers.map(function(marker) {
          photomap.removeLayer(marker);
      });
      markers = [];
      var points = photos.map(function(p) {
        var pa = p.attributes;
        if (pa.location) {
            var marker = L.marker(pa.location).bindPopup(
                '<a href="'+pa.url+'">'+pa.title+'</a>'
            ).addTo(photomap);
            
            markers.push(marker);
            
            return pa.location;
        }
      })
      if (points.length) {
        photomap.fitBounds(points);
      }
    }
    
    var photos = window.photos = [];
    var query = {{ search_query|json }};
        
    var search_app = new Vue({
        el: '#search-screen',
        data: {
            photos: photos,
            meta: {
                query: query,
                pagination: {},
                qs: '',
                status: 0,
                facets: {},
            },
        },
        mounted: function() {
            this.$nextTick(function () {
                this.call_api();
            })            
        },
        watch: {
            photos: function() {
                update_map(this.photos);
            },
            'meta.query.order': function() {
                this.call_api({page: 1});
            },
        },
        methods: {
            on_change_option: function(option, event) {
                option[4] = event.target.checked ? 1: 0;
                this.call_api({page: 1});
            },
            phrase_submit: function() {
                this.call_api({page: 1});
            },
            result_size: function() {
                if (this.status === 1) {
                    return 'Searching...';
                }
                return '' + this.photos.length + ' photo(s)';  
            },
            on_click_previous_page: function() {
                this.call_api({page: this.meta.query.page-1}); 
            },
            on_click_next_page: function() {
                this.call_api({page: this.meta.query.page+1});  
            },
            on_click_load_more: function() {
                this.call_api({
                    page: this.meta.query.page+1,
                    add: 1,
                });
            },
            call_api: function(aquery) {
                var self = this;
                self.status = 1;
                
                var query_facets = [];
                $.each(self.meta.facets, function(i, facet) {
                    $.each(facet[1], function(j, option) {
                        if (option[4]) {
                            query_facets.push(option[0]+':'+option[1]);
                        }
                    })
                });
                
                var query = $.extend(
                    {format: 'js',}, 
                    self.meta.query,
                    {facets: query_facets.join(';')},
                    aquery
                )
                
                var req = $.getJSON('/photos', query);
                req.done(function(data) {
                    if (!query.add) {
                        Vue.set(self, 'photos', []);
                    } 
                    Array.prototype.push.apply(self.photos, data.data);
                    self.updating_from_response = 1;
                    Vue.set(self, 'meta', data.meta);
                    self.updating_from_response = 0;
                    
                    replace_query_string(data.meta.qs);
                });
            },
        }
    }); 


    function replace_query_string(qs) {
        if (history.pushState) {
            var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + qs;
            window.history.pushState({path:newurl},'',newurl);
        }
    }

});

</script>
{% endblock %}

