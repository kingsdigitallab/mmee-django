{% extends 'base.html' %}
{% load wagtailimages_tags mmee_wagtail_tags %}

{% block main %}

{% verbatim %}
<main id="search-screen">

    <section id="search">

       <div class="search-field">
            <input v-model="query.phrase" @keyup.enter="phrase_submit">
            <button v-on:click="phrase_submit">Search</button>
            <button>My location</button>
        </div>
        <div class="search-filters">
            <div class="filter">
                <input type="checkbox" id="filter-nav" />
                <label aria-label="Filter list" class="filter-label" for="filter-nav">
                    Filter
                </label>
                <div class="filter-list">
                  <ul>
                    <li>
                      <h2>Filters</h2>
                      <form action="">
                        <h3>Categories</h3>
                        
                        <template v-for="facet in facets">
                            <h4>{{ facet[0] }}</h4>
                            <div v-for="option in facet[1]">
                                <label>
                                    <input type="checkbox" 
                                        v-bind:name="option[0]+':'+option[1]" 
                                        value="1" v-bind:checked="option[4]" 
                                        v-on:click="on_change_option(option, $event)">
                                    {{ option[2] }} ({{ option[3] }})
                                </label>
                            </div>
                        
                        </template>
                        
                        <button aria-label="apply filter">Apply filter</button>
                      </form>
                    </li>
                  </ul>
                </div>
            </div>
            <div class="sort">
                <select aria-label="Sort by" v-model="query.order">
                  <option value="newest">Newest</option>
                  <option value="oldest">Oldest</option>
                </select>
            </div>
        </div> <!-- end .filter-sort -->
    </section> <!-- end #search -->

    <section id="results">
        <p class="stats">{{ result_size() }}</p>
    
        <input id="tab1" type="radio" name="tabs"  checked>
        <label for="tab1"><span>Grid</span></label>

        <input id="tab2" type="radio" name="tabs">
        <label for="tab2"><span>List</span></label>

        <input id="tab3" type="radio" name="tabs">
        <label for="tab3"><span>Map</span></label>

        <article id="photo-grid" class="tab-content">
            <div v-for="photo in photos" class="photo">
              <div class="photo-image">
                <a v-bind:href="photo.url+'?'+qs" v-html="photo.image">
                </a>
              </div>
              <div class="photodata">
                <a v-bind:href="photo.url+'?'+qs">
                    <h2>{{ photo.title }}</h2>
                </a>
              </div>
            </div>
        </article>

        <article id="photo-list" class="tab-content">
            <div v-for="photo in photos" class="photo">
                <div class="photo-image">
                  <a v-bind:href="photo.url+'?'+qs" v-html="photo.image">
                  </a>
                </div>
                <div class="photodata">
                    <p>{{ photo.description }}</p>
                    <p v-if="photo.date">Date taken: {{ photo.date }}</p>
                  </div>
                </div>
            </div>
        </article>

        <article id="photo-map" class="tab-content">
          <div id="map">
          </div>
        </article>

    </section> <!-- end #results -->

</main>
{% endverbatim %}

{% endblock %}

{% block footer_scripts %}
<script>

$(function() {
    // Create map and set view
    var photomap = L.map('map').setView([51.52, -0.03], 12);
    // Create tilelayer and add to map
    var tileLayer = L.tileLayer("http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.png").addTo(photomap);
    var markers = [];

    function pain_map(photos) {
      markers.map(function(marker) {
          photomap.removeLayer(marker);
      });
      markers = [];
      var points = photos.map(function(p) {
        if (p.location) {
            var marker = L.marker(p.location).bindPopup(
                '<a href="'+p.url+'">'+p.title+'</a>'
            ).addTo(photomap);
            
            markers.push(marker);
            
            return p.location;
        }
      })
      if (points.length) {
        photomap.fitBounds(points);
      }
    }
    
    var photos = window.photos = [];
    var query = {{ search_query|json }};
        
    var search_app = new Vue({
        el: '#search-screen',
        data: {
            photos: photos,
            query: query,
            qs: '',
            status: 0,
            facets: {},
        },
        mounted: function() {
            this.$nextTick(function () {
                this.call_api();
            })            
        },
        watch: {
            photos: function() {
                pain_map(this.photos);
            },
            'query.order': function() {
                this.call_api();
            },
        },
        methods: {
            on_change_option: function(option, event) {
                console.log(event);
                option[4] = event.target.checked ? 1: 0;
                var t = 0;
                this.call_api();
            },
            phrase_submit: function() {
              this.call_api();  
            },
            result_size: function() {
                if (this.status === 1) {
                    return 'Searching...';
                }
                return '' + this.photos.length + ' photo(s)';  
            },
            call_api: function() {
                var self = this;
                self.status = 1;
                
                var query_facets = [];
                $.each(self.facets, function(i, facet) {
                    $.each(facet[1], function(j, option) {
                        if (option[4]) {
                            query_facets.push(option[0]+':'+option[1]);
                        }
                    })
                });
                
                var query = $.extend({
                    format: 'js',
                    facets: query_facets.join(';'),
                }, self.query)
                
                var req = $.getJSON('/photos', query);
                req.done(function(data) {
                    self.photos = data.photos;
                    self.status = 0;
                    self.facets = data.facets;
                    
                    self.qs = data.qs;
                    replace_query_string(data.qs);
                });
            },
        }
    }); 


    function replace_query_string(qs) {
        if (history.pushState) {
            var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + qs;
            window.history.pushState({path:newurl},'',newurl);
        }
    }

});

</script>
{% endblock %}

